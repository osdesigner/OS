<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تأكيد الطلب</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>فاتورة الطلب</h2>
      <p>شكراً لثقتكم بنا، هذه تفاصيل طلبكم</p>
      <div class="invoice-number">رقم الفاتورة: #<span id="invoiceNumber"></span></div>
    </div>

    <div class="invoice-card">
      <div class="customer-info">
        <div class="info-item">
          <h3>اسم العميل</h3>
          <p id="userName"></p>
        </div>
        <div class="info-item">
          <h3>رقم الهاتف</h3>
          <p id="userPhone"></p>
        </div>
        <div class="info-item">
          <h3>العنوان</h3>
          <p id="userAddress"></p>
        </div>
      </div>

      <div class="order-items" id="orderSummary"></div>

      <div class="order-total">
        <div class="total-row">
          <span class="total-label">الإجمالي:</span>
          <span class="total-value" id="subtotal"></span>
        </div>
      
        <div class="total-row grand-total">
          <span class="total-label">المبلغ الإجمالي:</span>
          <span class="total-value" id="grandTotal"></span>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button id="submitBtn"><i class="fas fa-paper-plane"></i> تأكيد الطلب</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIaEPGGOJcGEGcYD5_pntD6whM9Zk81Ok",
      authDomain: "ordars-578e0.firebaseapp.com",
      projectId: "ordars-578e0",
      storageBucket: "ordars-578e0.firebasestorage.app",
      messagingSenderId: "274691655392",
      appId: "1:274691655392:web:318fc9d4ecffd43e623285",
      measurementId: "G-S59P9T6NT0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // توليد رقم فاتورة عشوائي
    function generateInvoiceNumber() {
      return 'ORD-' + Math.floor(100000 + Math.random() * 900000);
    }
    
    const invoiceNumber = generateInvoiceNumber();
    document.getElementById('invoiceNumber').textContent = invoiceNumber;

    const name = localStorage.getItem("userName") || "غير معروف";
    const phone = localStorage.getItem("userPhone") || "غير متوفر";
    const address = localStorage.getItem("userAddress") || "غير متوفر";

    document.getElementById("userName").textContent = name;
    document.getElementById("userPhone").textContent = phone;
    document.getElementById("userAddress").textContent = address;

    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    const summary = document.getElementById("orderSummary");
    let subtotal = 0;
    
    if (cart.length === 0) {
      summary.innerHTML = '<p style="text-align: center; color: #95a5a6;">لا توجد عناصر في السلة</p>';
    } else {
      cart.forEach(item => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "order-item";
        itemDiv.innerHTML = `
          <img src="${item.image}" class="item-img" onerror="this.src='https://via.placeholder.com/80?text=صورة+المنتج'" alt="${item.name}">
          <div class="item-details">
            <h4 class="item-name">${item.name}</h4>
            <div class="item-meta">
              <span>الكمية: ${item.quantity}</span>
              <span class="item-price">${item.price * item.quantity} جنيه</span>
            </div>
            ${item.notes ? `<p class="item-notes">ملاحظات: ${item.notes}</p>` : ''}
          </div>
        `;
        subtotal += item.quantity * item.price;
        summary.appendChild(itemDiv);
      });
    }

    
    const grandTotal = subtotal;
    
    document.getElementById("subtotal").textContent = subtotal + " جنيه";
    document.getElementById("grandTotal").textContent = grandTotal + " جنيه";


    document.getElementById("submitBtn").addEventListener("click", async () => {
      if (cart.length === 0) {
        alert("السلة فارغة");
        return;
      }

      // تحقق من تسجيل الدخول
      if (!name || name === "غير معروف" || !phone || phone === "غير متوفر") {
        alert("يجب تسجيل الدخول أولاً لإرسال الطلب.");
        window.location.href = "https://os-desin.vercel.app/login/login.html";
        return;
      }

      const orderData = {
        customer: { name, phone, address },
        items: cart,
        subtotal,

        grandTotal,
        invoiceNumber,
        status: "قيد المراجعة",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("orders").add(orderData);
        alert("تم إرسال الطلب بنجاح");
        localStorage.removeItem("cart");
      } catch (error) {
        console.error("خطأ في الإرسال", error.message);
        alert("حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.");
      }
    });
  </script>
</body>
</html>